# 🚢 ESS HMI PLC 시뮬레이터 사용 가이드

## 📋 개요

실제 PLC 장비가 없어도 ESS HMI 시스템을 테스트할 수 있도록 가상 PLC 시뮬레이터를 제공합니다.

## ✨ 시뮬레이터 기능

### 1. 실시간 센서 데이터 생성
- **온도 센서 (TX1~TX5B)**: 실제와 유사한 온도 변화 시뮬레이션
- **압력 센서 (PX1)**: 3.5 kg/cm² 기준 ±0.2 변동
- **부하 센서 (PU1)**: M/E 부하 10~100% 자동 변동

### 2. 펌프 시뮬레이션
- **6개 펌프 제어**: SWP1, SWP2, SWP3, FWP1, FWP2, FWP3
- **자동 주파수 조절**: M/E 부하에 따라 펌프 주파수 자동 조정
- **VFD 데이터**: 주파수, 전력, 절감량, 운전시간 등 실시간 계산
- **HMI 명령 처리**: START/STOP 명령 실시간 반영

### 3. Modbus TCP 서버
- **프로토콜**: Modbus TCP
- **주소**: 127.0.0.1:502
- **Node ID**: 3
- **레지스터**: 10,000개 홀딩 레지스터

## 🚀 빠른 시작

### 방법 1: 통합 실행 (권장)

**관리자 권한으로 실행:**

```batch
start_with_simulator.bat
```

또는 PowerShell:

```powershell
.\start_with_simulator.ps1
```

이 방법은 다음을 자동으로 실행합니다:
1. PLC 시뮬레이터
2. 백엔드 서버
3. 프론트엔드

### 방법 2: 시뮬레이터만 실행

**관리자 권한으로 실행:**

```batch
start_simulator_only.bat
```

그 다음 별도로 백엔드와 프론트엔드를 실행하세요.

## ⚠️ 중요 사항

### 관리자 권한 필요
Modbus TCP는 기본적으로 **포트 502**를 사용하며, Windows에서는 1024 이하 포트를 사용하려면 **관리자 권한**이 필요합니다.

**관리자 권한으로 실행하는 방법:**
1. 배치 파일을 **마우스 오른쪽 버튼**으로 클릭
2. **"관리자 권한으로 실행"** 선택

### 포트 충돌 확인
포트 502가 이미 사용 중인 경우:

```powershell
# 포트 사용 확인
netstat -ano | findstr :502

# 프로세스 종료 (PID 확인 후)
taskkill /PID [PID번호] /F
```

## 📊 시뮬레이터 출력 정보

시뮬레이터 실행 시 5초마다 다음 정보를 출력합니다:

```
============================================================
🕐 2025-10-19 14:30:00
------------------------------------------------------------
🔥 M/E 부하: 65.3%
🌡️  온도: TX1=30.5°C
💨 압력: PX1=3.6 kg/cm²
------------------------------------------------------------
SWP1: 🟢 운전중 | 55.2Hz | 자동
SWP2: ⚪ 정지 | 0.0Hz | 자동
SWP3: ⚪ 정지 | 0.0Hz | 자동
FWP1: 🟢 운전중 | 50.0Hz | 자동
FWP2: ⚪ 정지 | 0.0Hz | 자동
FWP3: ⚪ 정지 | 0.0Hz | 자동
============================================================
```

## 🎮 HMI에서 펌프 제어

1. 웹 브라우저에서 `http://localhost:5173` 접속
2. 대시보드 또는 펌프 제어 화면으로 이동
3. 펌프 START/STOP 버튼 클릭
4. 시뮬레이터 창에서 명령 수신 확인:
   ```
   ▶️  SWP2 시작 명령 수신
   ⏸️  SWP1 정지 명령 수신
   ```

## 🔧 시뮬레이터 설정 변경

`simulator/plc_simulator.py` 파일에서 다음을 수정할 수 있습니다:

### 초기 펌프 상태
```python
self.pumps = {
    'SWP1': {'running': True, 'hz': 45, 'mode': 'vfd', 'auto': True},
    'SWP2': {'running': False, 'hz': 0, 'mode': 'vfd', 'auto': True},
    # ...
}
```

### 센서 베이스 값
```python
self.base_temp = 30.0      # 기본 온도 (°C)
self.base_pressure = 3.5   # 기본 압력 (kg/cm²)
self.me_load = 50          # M/E 부하 (%)
```

### 업데이트 주기
```python
time.sleep(1)  # 1초마다 업데이트 (기본값)
```

## 🐛 문제 해결

### 1. "관리자 권한이 필요합니다" 오류
- 배치 파일을 **관리자 권한으로 실행**하세요

### 2. "포트 502를 사용할 수 없습니다" 오류
- 다른 프로그램이 포트 502를 사용 중입니다
- 해당 프로그램을 종료하거나 시뮬레이터 포트를 변경하세요

### 3. "pymodbus 라이브러리가 없습니다" 오류
```bash
cd backend
venv\Scripts\activate
pip install pymodbus
```

### 4. 백엔드가 시뮬레이터에 연결되지 않음
- 시뮬레이터가 먼저 실행되었는지 확인
- 시뮬레이터 창에 "✅ 시뮬레이터 준비 완료!" 메시지 확인
- 백엔드 로그에서 "✅ PLC 연결 성공" 메시지 확인

### 5. 데이터가 여전히 0으로 표시됨
1. 시뮬레이터가 실행 중인지 확인
2. 백엔드 서버가 127.0.0.1:502로 연결되었는지 확인
3. 브라우저 개발자 도구(F12)에서 WebSocket 연결 확인
4. 페이지 새로고침 (Ctrl+F5)

## 📈 시뮬레이션 동작 원리

### 1. 온도 시뮬레이션
- **TX1 (CSW 펌프 토출)**: 30°C ± 2°C 랜덤 변동
- **TX2, TX3 (냉각기 출구)**: 30°C + 1~3°C
- **TX4A/B (냉각기 입구)**: 75°C ± 5°C
- **TX5A/B (냉각기 출구)**: 60°C ± 3°C

### 2. 압력 시뮬레이션
- 기준: 3.5 kg/cm²
- 변동: ±0.2 kg/cm²

### 3. M/E 부하 시뮬레이션
- 범위: 10~100%
- 변화: 매초 ±2% 랜덤 변동
- 펌프 주파수에 영향

### 4. 펌프 주파수 자동 조절
```
목표 주파수 = 30Hz + (M/E 부하 × 0.5)
```
- M/E 부하 20% → 40Hz
- M/E 부하 60% → 60Hz
- M/E 부하 100% → 80Hz

### 5. 전력 계산 (3제곱 법칙)
```
전력 = (현재Hz / 60Hz)³ × 최대전력
```
- 30Hz → 12.5% 전력
- 45Hz → 42.2% 전력
- 60Hz → 100% 전력

## 🔄 실제 PLC로 전환

시뮬레이터 대신 실제 PLC를 사용하려면:

1. `backend/main.py` 파일에서 PLC 주소 변경:
   ```python
   plc_client = PLCClient(host="192.168.1.100", port=502, slave_id=3)
   ```

2. 실제 PLC IP 주소로 변경

3. 시뮬레이터 없이 백엔드와 프론트엔드만 실행:
   ```batch
   start.bat
   ```

## 📞 지원

문제가 발생하면:
1. 시뮬레이터 로그 확인
2. 백엔드 로그 확인 (`backend` 창)
3. 브라우저 개발자 도구 콘솔 확인 (F12)

---

**🎉 이제 실제 PLC 없이도 ESS HMI 시스템을 완전히 테스트할 수 있습니다!**


