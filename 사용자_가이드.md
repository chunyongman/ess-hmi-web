# 📘 ESS HMI 사용자 가이드

## 🎯 목차

1. [시스템 개요](#시스템-개요)
2. [설치 및 실행](#설치-및-실행)
3. [화면 설명](#화면-설명)
4. [데이터 수정 방법](#데이터-수정-방법)
5. [실제 PLC 연결](#실제-plc-연결)
6. [문제 해결](#문제-해결)

---

## 시스템 개요

### 무엇을 하는 시스템인가요?

이 시스템은 선박의 **냉각수 펌프**(해수 펌프 3대, 청수 펌프 3대)를 자동으로 제어하여 에너지를 절감하는 HMI 프로그램입니다.

### 원본 프로그램과의 차이점

| 항목 | 원본 (SMT_HMI.exe) | 웹 버전 (이 시스템) |
|------|-------------------|-------------------|
| 플랫폼 | Windows 전용 실행파일 | 웹 브라우저 |
| 수정 | 불가능 (바이너리) | 완전히 수정 가능 |
| 접속 | 로컬 PC만 | 네트워크 내 모든 기기 |
| 모바일 | 지원 안 함 | 반응형 지원 |
| 개발 도구 | 알 수 없음 | Python + React |

---

## 설치 및 실행

### 1단계: 필수 프로그램 설치

#### Python 설치 (3.8 이상)
1. https://www.python.org/downloads/ 접속
2. "Download Python" 클릭
3. 설치 시 **"Add Python to PATH"** 체크 필수!

#### Node.js 설치 (16 이상)
1. https://nodejs.org/ 접속
2. LTS 버전 다운로드
3. 기본 설정으로 설치

### 2단계: 패키지 설치

#### 방법 A: 자동 설치 (권장)
```powershell
# PowerShell 관리자 모드에서:
cd C:\Users\my\Desktop\HMI\ess-hmi-web
.\start.ps1
```

첫 실행 시 자동으로 모든 패키지를 설치합니다!

#### 방법 B: 수동 설치

**Python 패키지:**
```bash
cd backend
pip install -r requirements.txt
```

**Node.js 패키지:**
```bash
cd frontend
npm install
```

### 3단계: 시스템 실행

#### 원클릭 실행 (가장 쉬움!)

```powershell
# 관리자 모드 PowerShell에서:
.\start.ps1
```

3개의 창이 자동으로 열립니다:
1. PLC 시뮬레이터
2. 백엔드 서버
3. 프론트엔드 웹서버

5초 후 브라우저가 자동으로 열립니다!

#### 수동 실행 (개발자용)

**터미널 1 - PLC 시뮬레이터:**
```bash
cd simulator
python plc_simulator.py
```

**터미널 2 - 백엔드:**
```bash
cd backend
python main.py
```

**터미널 3 - 프론트엔드:**
```bash
cd frontend
npm run dev
```

### 4단계: 접속

브라우저에서 접속:
```
http://localhost:3000
```

---

## 화면 설명

### 📊 대시보드 탭

![대시보드 설명]

**시스템 개요 카드**
- 총 절감 전력 (kWh)
- 총 운전 시간
- 현재 운전 중인 펌프 수
- M/E 부하율

**센서 데이터 섹션**
- TX1~TX5: 온도 센서 (°C)
- PX1: 압력 센서 (kg/cm²)
- PU1: M/E 부하 (%)

**펌프 상태 카드**
각 펌프별로 표시:
- 운전 상태 (운전중/정지)
- 현재 주파수 (Hz)
- 소비 전력 (kW)
- 절감 전력량 (kWh)
- 절감률 (%)
- 운전 시간 (h)

### ⚙️ 펌프 제어 탭

**펌프 선택**
- 펌프 카드를 클릭하면 선택됩니다
- 선택된 펌프는 파란색 테두리로 강조

**제어 버튼**
- ▶️ 시작: 펌프를 시작합니다
- ⏸️ 정지: 펌프를 정지합니다

**상세 정보 패널**
- 선택한 펌프의 모든 정보 표시
- 실시간으로 업데이트

### 📈 트렌드 탭

**4개의 그래프**
1. 온도 트렌드 (TX1)
2. 압력 트렌드 (PX1)
3. M/E 부하 트렌드
4. 총 소비 전력

**그래프 기능**
- 최근 50개 데이터 포인트
- 1초마다 자동 업데이트
- 최소/최대값 표시

### 🔔 알람 탭

**알람 개요**
- 위험 알람 수 (빨강)
- 경고 알람 수 (노랑)
- 정보 알람 수 (초록)

**알람 목록**
- 시간순으로 정렬
- 확인 버튼으로 알람 확인

---

## 데이터 수정 방법

### PLC 주소 매핑 변경

실제 PLC의 레지스터 주소가 다르다면:

**파일:** `backend/modbus_client.py`

**센서 데이터 수정:**
```python
async def get_sensor_data(self) -> Dict[str, Any]:
    # W10~W19 읽기 (주소 변경 가능)
    sensor_regs = await self.read_holding_registers(10, 10)
    
    return {
        "TX1": round(sensor_regs[0] / 10.0, 1),  # W10
        "TX2": round(sensor_regs[1] / 10.0, 1),  # W11
        # 새 센서 추가:
        "NEW_SENSOR": round(sensor_regs[8] / 10.0, 1),
    }
```

**펌프 데이터 수정:**
```python
async def get_pump_data(self, pump_index: int):
    # 시작 주소 변경
    data_offsets = [160, 168, 176, 184, 192, 200]  # 수정 가능
    bit_offsets = [0, 3, 6, 9, 12, 15]             # 수정 가능
    
    # ...
```

### UI 표시 항목 변경

**파일:** `frontend/src/components/Dashboard.jsx`

**센서 추가:**
```jsx
<SensorCard 
  label="새 센서 이름" 
  value={sensors.NEW_SENSOR} 
  unit="단위" 
  icon="🌡️" 
/>
```

**통계 카드 추가:**
```jsx
<div className="stat-card">
  <div className="stat-icon">💡</div>
  <div className="stat-content">
    <div className="stat-label">내 통계</div>
    <div className="stat-value">{myValue}</div>
  </div>
</div>
```

### 색상/스타일 변경

**파일:** `frontend/src/components/Dashboard.css`

```css
/* 주요 색상 변경 */
.stat-value {
  color: #3b82f6;  /* 파랑 → 원하는 색상 */
}

/* 카드 배경 변경 */
.stat-card {
  background: linear-gradient(135deg, #334155 0%, #1e293b 100%);
}
```

### 수정 후 반영

파일을 저장하면 **자동으로 반영**됩니다!
- 백엔드 수정: 서버 자동 재시작
- 프론트엔드 수정: 브라우저 자동 새로고침

---

## 실제 PLC 연결

### 1단계: 네트워크 설정

PLC와 PC가 같은 네트워크에 있어야 합니다.

**PLC IP 확인:**
- 원본 프로그램의 `MbServer.ini`에서 확인
- 예: `192.168.0.130`

**PC 네트워크 설정:**
1. 제어판 → 네트워크 어댑터
2. IP 주소를 같은 대역으로 설정
   - 예: `192.168.0.100`
   - 서브넷: `255.255.255.0`

### 2단계: PLC IP 변경

**파일:** `backend/main.py`

```python
# 22번 줄 수정:
plc_client = PLCClient(
    host="192.168.0.130",  # 실제 PLC IP로 변경
    port=502, 
    slave_id=3
)
```

### 3단계: 시뮬레이터 끄고 실행

```powershell
# PLC 시뮬레이터는 실행하지 않음!

# 백엔드만 실행
cd backend
python main.py

# 프론트엔드 실행
cd frontend
npm run dev
```

### 4단계: 연결 확인

1. 브라우저에서 `http://localhost:3000` 접속
2. 우측 상단 상태 표시 확인:
   - 🟢 "PLC 연결됨" → 성공!
   - 🔴 "PLC 연결 안됨" → 문제 확인

**연결 실패 시:**
- PLC 전원 확인
- 네트워크 케이블 확인
- IP 주소 핑 테스트: `ping 192.168.0.130`
- 방화벽 설정 확인

---

## 문제 해결

### Q1: "pip을 찾을 수 없습니다"

**원인:** Python PATH 설정 누락

**해결:**
1. Python 재설치
2. "Add Python to PATH" 체크
3. 또는 수동으로 PATH 추가

### Q2: "npm을 찾을 수 없습니다"

**원인:** Node.js PATH 설정 누락

**해결:**
1. PC 재부팅
2. 또는 Node.js 재설치

### Q3: 포트 8000이 이미 사용 중

**원인:** 다른 프로그램이 8000번 포트 사용

**해결 A:** 다른 프로그램 종료
```powershell
netstat -ano | findstr :8000
taskkill /PID [PID번호] /F
```

**해결 B:** 포트 변경
`backend/main.py` 마지막 줄:
```python
uvicorn.run("main:app", host="0.0.0.0", port=8001)  # 8000 → 8001
```

### Q4: 포트 502 권한 오류

**원인:** 관리자 권한 필요

**해결:** PowerShell을 관리자 모드로 실행

### Q5: WebSocket 연결 실패

**원인:** 백엔드 서버 미실행

**해결:** 
1. `http://localhost:8000` 접속 테스트
2. 백엔드 터미널 확인
3. 오류 메시지 확인

### Q6: 센서 값이 0으로만 표시

**원인:** PLC 통신 실패

**해결:**
1. PLC 시뮬레이터 실행 확인
2. PLC IP 주소 확인
3. 방화벽 해제 시도

### Q7: 펌프 명령이 작동하지 않음

**원인:** 
- PLC 쓰기 권한 없음
- Modbus 주소 불일치

**해결:**
1. PLC 설정에서 쓰기 권한 확인
2. 레지스터 주소 확인
3. 백엔드 로그 확인

---

## 💡 팁과 트릭

### 개발자 도구 활용

브라우저에서 `F12`를 누르면:
- Console: 로그 메시지 확인
- Network: API 통신 확인
- WebSocket: 실시간 데이터 확인

### 데이터 로깅

백엔드에서 자동으로 로그를 기록합니다:
- 센서 값 변화
- 펌프 명령
- 통신 오류

### 성능 최적화

데이터 업데이트 주기 변경:
`backend/main.py`:
```python
# 1초 → 2초로 변경
await asyncio.sleep(2)  # 원래 1
```

### 원격 접속

다른 PC/태블릿에서 접속:
```
http://서버PC_IP주소:3000
```

예: `http://192.168.0.100:3000`

---

## 🎓 다음 단계

### 고급 기능 추가

1. **사용자 로그인**
   - 인증 시스템 추가
   - 권한별 접근 제어

2. **데이터베이스 연동**
   - 이력 데이터 저장
   - 장기 통계 분석

3. **알람 시스템 확장**
   - 이메일/SMS 알림
   - 알람 규칙 커스터마이징

4. **리포트 자동 생성**
   - 일일/주간/월간 리포트
   - PDF 내보내기

5. **모바일 앱 개발**
   - React Native 사용
   - 푸시 알림

### 배포

**Docker로 배포:**
```bash
docker-compose up -d
```

**클라우드 배포:**
- AWS, Azure, Google Cloud
- Netlify, Vercel

---

**도움이 필요하면 언제든지 문의하세요!** 😊




